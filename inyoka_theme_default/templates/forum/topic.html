{#
  forum/topic.html
  ~~~~~~~~~~~~~~~~

  This page shows a single topic.
  It displays the posts itself, the author and publishing date of a post.
  If the topic grows, it is divided into pages.

  :copyright: (c) 2013-2019 by the Inyoka Team, see AUTHORS for more details.
  :license: BSD, see LICENSE for more details.
#}

{% extends 'forum/base.html' %}

{% set name = topic.title|e %}
{% set feeds = [
  (name + ' - ' + _('Captions'), href('forum', 'feeds/topic', topic.slug, 'title/20')),
  (name + ' - ' + _('Teaser'), href('forum', 'feeds/topic', topic.slug, 'short/20')),
  (name + ' - ' + _('Full'), href('forum', 'feeds/topic', topic.slug, 'full/20'))
] %}

{% block title %}
  {{ topic }} – {{ topic.forum }} – {{ super() }}
{% endblock %}

{% block breadcrumb %}
  {{ super() }}

  {% for parent in forum.parents|reverse %}
    {{ macros.breadcrumb_item(parent.name, parent|url) }}
  {% endfor %}
  {{ macros.breadcrumb_item(topic.forum, topic.forum|url) }}
  {{ macros.breadcrumb_item(topic, topic|url) }}
{% endblock %}

{% block sidebar %}
  {{ super() }}

  {% if USER.is_authenticated() %}
    {% call macros.sidebar() %}
      {% if (can_reply and not topic.locked) or can_moderate %}
        {{ macros.sidebar_item(_('Reply'), topic|url('reply'), 'fa_icon-comments-o') }}
      {% endif %}

      {% if is_subscribed %}
        {{ macros.sidebar_item(_('Unsubscribe'), topic|url('unsubscribe'), 'fa_icon-bell-slash') }}
      {% else %}
        {{ macros.sidebar_item(_('Subscribe'), topic|url('subscribe'), 'fa_icon-bell') }}
      {% endif %}

      {% if topic.solved %}
        {{ macros.sidebar_item(_('Mark as unsolved'), topic|url('unsolve'), 'fa_icon-remove') }}
      {% else %}
        {{ macros.sidebar_item(_('Mark as solved'), topic|url('solve'), 'fa_icon-check') }}
      {% endif %}

      {{ macros.sidebar_item(_('Report'), topic|url('report'), 'fa_icon-exclamation-triangle') }}
    {% endcall %}
  {% endif %}

  {% if can_moderate %}
    {% call macros.sidebar_admin() %}
      {{ macros.sidebar_item(_('Move'), topic|url('move'), 'fa_icon-arrow-circle-right') }}

      {{ macros.sidebar_item(_('Split'), topic|url('split'), 'fa_icon-scissors') }}

      {% if topic.locked %}
        {{ macros.sidebar_item(_('Unlock'), topic|url('unlock'), 'fa_icon-unlock') }}
      {% else %}
        {{ macros.sidebar_item(_('Lock'), topic|url('lock'), 'fa_icon-lock') }}
      {% endif %}

      {% if topic.hidden %}
        {{ macros.sidebar_item(_('Restore'), topic|url('restore'), 'fa_icon-eye') }}
        {{ macros.sidebar_item(_('Delete'), topic|url('delete'), 'fa_icon-trash') }}
        {{ macros.sidebar_item(_('Mark ham'), topic.first_post|url('ham'), 'fa_icon-recycle') }}
      {% else %}
        {{ macros.sidebar_item(_('Hide'), topic|url('hide'), 'fa_icon-eye-slash') }}
        {{ macros.sidebar_item(_('Mark spam'), topic.first_post|url('spam'), 'fa_icon-fire') }}
      {% endif %}
    {% endcall %}
  {% endif %}
{% endblock %}

{% block content %}
  {% set rendered_pagination = macros.render_pagination(pagination) %}

  <h1>{{ topic.title|e }}</h1>

  {% if discussions %}
    {% macro render_article_list(discussions) %}
      {% for article in discussions %}
        <a class="article_discussion_list" href="{{ article|url }}">{{ article.name|e }}</a>
      {% if not loop.last %},{% endif %}
      {% endfor %}
    {% endmacro %}

    {% call macros.render_message('info') %}
      {% trans count=discussions|count, article_list=render_article_list(discussions) %}
        This topic is the discussion of the article {{ article_list }}.
      {% pluralize %}
        This topic is the discussion of the articles {{ article_list }}.
      {% endtrans %}
    {% endcall %}
  {% endif %}

  {{ rendered_pagination }}

  {% if polls %}
    {% include 'forum/topic__polls.html' %}
  {% endif %}

  {% for post in posts %}
    <div class="forum-post {% if post.hidden %}forum-post-muted{% endif %}" id="post-{{ post.id }}">
      <div class="forum-post-heading">
        <span class="pull-right">
          <a href="{{ post|url }}">
            <time datetime="{{ post.pub_date|datetime('c') }}">{{ post.pub_date|datetime }}</time>
          </a>
        </span>
        <a href="{{ post.author|url }}">{{ post.author }}</a>
      </div>

      <div class="forum-post-body">
        {{ post.get_text() }}

        {% if post.author.signature and not USER.settings['hide_signatures'] %}
          <div class="forum-post-body-signature">
            {{ post.author.signature_rendered }}
          </div>
        {% endif %}
      </div>

      <div class="forum-post-footer">
        <div class="button-group"{% if topic.locked %} data-toggle="tooltip" data-placement="right"
             title="{% trans %}The topic is locked{% endtrans %}"{% endif %}>
          <a href="{{ post|url('quote') }}" class="btn btn-default{% if topic.locked %} disabled{% endif %}">
            {% trans %}Quote{% endtrans %}
          </a>
          {% if can_edit(post) %}
            <a href="{{ post|url('edit') }}" class="btn btn-primary{% if topic.locked %} disabled{% endif %}">
              {% trans %}Edit{% endtrans %}</a>
          {% endif %}
        </div>
        {% if can_moderate %}
          <div class="staff-dropdown">
            <button type="button" class="staff-dropdown-button" data-toggle="dropdown">
              {% trans %}Staff{% endtrans %}
              <span class="fa_icon-caret-down"></span>
            </button>
            <ul class="staff-dropdown-menu">
              <li><a href="{{ post|url('edit') }}">{% trans %}Edit{% endtrans %}</a></li>
              {% if post.hidden %}
                <li><a href="{{ post|url('restore') }}">{% trans %}Restore{% endtrans %}</a></li>
              {% else %}
                <li><a href="{{ post|url('hide') }}">{% trans %}Hide{% endtrans %}</a></li>
              {% endif %}
              {% if can_moderate and topic.locked %}
                <li><a href="{{ post|url('quote') }}">{% trans %}Quote{% endtrans %}</a></li>
              {% endif %}
            </ul>
          </div>
        {% endif %}
      </div>
    </div>
  {% endfor %}

  {{ rendered_pagination }}
{% endblock %}
