{#
  portal/privmsg/index.html
  ~~~~~~~~~~~~~~~~~~~~~~~~~

  Display a list of private messages.

  :copyright: (c) 2013-2015 by the Inyoka Team, see AUTHORS for more details.
  :license: BSD, see LICENSE for more details.
#}

{% extends 'portal/privmsg/base.html' %}

{% block breadcrumb %}
  {{ super() }}
  {{ macros.breadcrumb_item(_(folder.name)) }}
{% endblock %}

{% block content %}
  {%- if message %}
    <div class="message">
      <div class="head">
        <div class="row">
          <div class="col-sm-9">
            <dl>
              <dt>{% trans %}From:{% endtrans %}</dt>
              <dd>
                <a{% if not message.author.is_active %} class="user_inactive"{% endif %} href="{{ message.author|url }}">
                  {{- message.author|e }}
                </a>
              </dd>
              <dt>{% trans %}To:{% endtrans %}</dt>
              <dd>
                {% for user in message.recipients -%}
                  <a{% if not user.is_active %} class="user_inactive"{% endif %} href="{{ user|url }}">{{ user|e }}</a>
                  {%- if not loop.last %}, {% endif %}
                {% else %}
                  …
                {% endfor %}
              </dd>
              <dt>{% trans %}Subject:{% endtrans %}</dt>
              <dd>{{ message.subject|e }}</dd>
              <dt>{% trans %}Date:{% endtrans %}</dt>
              <dd>{{ message.pub_date|datetime }}</dd>
            </dl>
          </div>
          <div class="col-sm-3 avatar">{{ macros.add_user_avatar(message.author) }}</div>
        </div>
      </div>      
      <div class="body">
        {{ message.rendered_text }}
      </div>
      <div class="foot">
        {%- if not message.author == USER %}
          {% if message.author.is_active %}
            <a class="pn_reply" href="{{ message|url('reply') }}"><i class="fa_icon-reply"></i> <span>{% trans %}Reply{% endtrans %}</span></a> |
          {%- endif %}

          {%- if message.recipients|length > 1 %}
            <a class="pn_reply_all" href="{{ message|url('reply_to_all') }}"><i class="fa_icon-reply-all"></i> <span>{% trans %}Reply to all{% endtrans %}</span></a> |
          {%- endif %}
        {%- endif %}
        <a class="pn_forward" href="{{ message|url('forward') }}"><i class="fa_icon-share"></i> <span>{% trans %}Forward{% endtrans %}</span></a> |
        {%- if folder.id == 'trash' %}
          <a class="pn_restore" href="?action=restore"><i class="fa_icon-arrow-up"></i> <span>{% trans %}Restore{% endtrans %}</span></a> |
        {%- elif folder.id != 'archive' %}
          <a class="pn_archive" href="?action=archive"><i class="fa_icon-archive"></i> <span>{% trans %}Archive{% endtrans %}</span></a> |
        {%- endif %}
        <a class="pn_delete" href="?action=delete"><i class="fa_icon-trash-o"></i> <span>{% trans %}Delete message{% endtrans %}</span></a>
      </div>
      <div class="spam-info">
        {%- trans moderators='http://wiki.ubuntuusers.de/ubuntuusers/Moderatoren' -%}
          If you received a spam message, please forward it to a <a href="{{ moderators }}">moderator</a>.
        {%- endtrans -%}
      </div>
    </div>
  {%- endif %}

  <form action="" method="post">
    {{ csrf_token() }}
    <table class="portal-privmsg-table portal-privmsg-responsive-table table table-striped">
      <colgroup>
          <col class="subjectcol">
          <col class="authorcol">
          <col class="recipientscol">
          <col class="datecol">
          <col class="actionscol">
          <col class="deletecol">
      </colgroup>
      <thead>
        <tr>
          <th class="subject">{% trans %}Subject{% endtrans %}</th>
          <th class="author">{% trans %}From{% endtrans %}</th>
          <th class="recipients">{% trans %}To{% endtrans %}</th>
          <th class="date">{% trans %}Date{% endtrans %}</th>
          <th class="actions">{% trans %}Actions{% endtrans %}</th>
          <th class="delete">{% trans %}Delete{% endtrans %} <input type="checkbox" ></th>
        </tr>
      </thead>
      <tbody>
      {%- for entry in entries %}
        <tr{% if message == entry.message %} class="active_pn"{% endif %}>
          <td data-title="{% trans %}Subject{% endtrans %}">
            {% if not entry.read %}<strong>{% endif -%}
              <a href="{{ entry|url }}">{{ entry.message.subject|e|truncate(50,false,'...') }}</a>
            {%- if not entry.read %}</strong>{% endif %}
          </td>
          <td data-title="{% trans %}From{% endtrans %}">
            <a{% if not entry.message.author.is_active %} class="user_inactive"{% endif %} href="{{ entry.message.author|url }}">
            {{- entry.message.author|e -}}
            </a>
          </td>
          <td data-title="{% trans %}To{% endtrans %}">
            {%- if entry.message.recipients|length == 0 %}
              <a{% if not entry.message.author.is_active %} class="user_inactive"{% endif %} href="{{ entry.message.author|url }}">
              {{- entry.message.author|e -}}
              </a>
            {% else %}
              <a{% if not entry.message.recipients[0].is_active %} class="user_inactive"{% endif %} href="{{ entry.message.recipients[0]|url }}">
              {{- entry.message.recipients[0]|e -}}
              </a>
            {%- endif %}
            {%- if entry.message.recipients|length > 1 %}, …{% endif %}
          </td>
          <td data-title="{% trans %}Date{% endtrans %}">{{ entry.message.pub_date|datetime }}</td>
          <td data-title={% trans %}Actions{% endtrans %} class="actions">
            {%- if not entry.is_own_message %}
              {% if entry.message.author.is_active %}
                <a href="{{ entry|url('reply') }}" title="{% trans %}Reply{% endtrans %}">
                  <i class="fa_icon-reply"></i>
                </a>
              {%- endif -%}
              {%- if entry.message.recipients|length > 1 %}
                <a href="{{ entry|url('reply_to_all') }}" title="{% trans %}Reply to all{% endtrans %}">
                  <i class="fa_icon-reply-all"></i>
                </a>
              {%- endif -%}
            {%- endif %}
            <a href="{{ entry|url('forward') }}" title="{% trans %}Forward{% endtrans %}">
             <i class="fa_icon-share"></i>
            </a>
            {%- if not entry.in_archive %}
              <a href="{{ entry|url }}?action=archive" title="{% trans %}Archive{% endtrans %}">
                <i class="fa_icon-archive"></i>
              </a>
            {%- endif %}
          </td>
          <td data-title="{% trans %}Delete{% endtrans %}" class="pn_delete">
            <input type="checkbox" name="delete" value="{{ entry.id }}" />
          </td>
        </tr>
        {%- else %}
        <tr>
          <td colspan="6">
            {% trans %}Currently there are no messages in this folder.{% endtrans %}
          </td>
        </tr>
      {%- endfor %}
    </tbody>
    <tfoot>
      <tr>
        <td colspan="6">
          <div class="pnfooter">
            {{ macros.render_pagination(pagination) }}
            <p class="onepage">
              {% if one_page %}
                <a href="{{ href('portal', 'privmsg', folder.id) }}">
                 {%- trans %}Split messages into multiple pages{% endtrans -%}
                </a>
              {% else %}
                <a href="{{ href('portal', 'privmsg', folder.id, 'all') }}">
                  {%- trans %}Display all messages on one page{% endtrans -%}
                </a>
              {% endif %}
            </p>
          </div>
          <p class="linklist">
            <a href="{{ href('portal', 'privmsg', 'new') }}" class="button">{% trans %}Compose message{% endtrans %}</a>
            <input type="submit" value="{% trans %}Delete marked messages{% endtrans %}" class="button-delete" />
          </p>
        </td>
        </tr>
      </tfoot>
    </table>
  </form>
{% endblock %}

{% block scripts %}
{{ super() }}
<script type="text/javascript">
  /* <![CDATA[ */
  $(function () {
    var all_checked = false;
    $('.portal-privmsg-table .delete input[type="checkbox"]').click(function() {
      $('input[name="delete"]').each(function() {
        if (all_checked)
          this.checked = false;
        else
          this.checked = true;
      });
      if (all_checked)
        all_checked = false;
      else
        all_checked = true;
    });
  })
  /* ]]> */
</script>
{% endblock %}
